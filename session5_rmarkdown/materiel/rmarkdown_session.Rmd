---
title: "Réaliser des rapports d'analyses en ``Rmarkdown``"
output:
  html_document:
    toc: yes
    toc_float: yes
  pdf_document:
    toc: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

[Retour à la page d'accueil](https://scortijo.github.io/2021_L3_R/)

# Introduction à ``Rmarkdown``

Lors de cette séance nous allons apprendre à rédiger des rapports d'analyse R en ``Rmarkdown``. L'idée n'est plus de produire de simples scripts (des documents en ``.R`` comme jusqu'à présent), mais des documents lisibles par tout le monde, y les personnes ne sachant pas programmer en R. Ces documents contiendront des explications, du contexte, vos lignes de code R, et leurs sorties (les graphiques générés par exemple). Nous allons donc illustrer les possibilités offertes par le langage ``Rmarkdown``, en faisant une courte analyse en R des données connues de burghardt_et_al_2015, et en exportant ces analyses dans un rapport complet et documenté.


Plus précisément, [Rmarkdown](http://rmarkdown.rstudio.com) est une syntaxe permettant la rédaction de documents HTML, PDF, parmi d'autres formats.
Il est possible d'y inclure du code R et ses sorties, en les encapsulant dans un rapport en structuré et fourni en descriptions , interprétations textuelles, liens, images...


## Pourquoi utliliser du Rmarkdown?

+ Ce format permet la **communication** de méthodes et de résultats de manière claire et commentée, particulièrement à des non spécialistes de l'informatique ou des statistiques.

+ La **reproductibilité** des analyses est garantie, car le code ayant généré les résultats montrés est présent, et peut être réexécuté par toute personne possédant le document.

En résumé, ce format de rapport favorise l'intégrité scientifique des travaux de recherche faisant appel à R.

## Structure d'un document et fonctionnement

Un document ``Rmarkdown`` comprend 3 types de contenu : 

+ Un **header** au format YAML (Yet Another Markup Langage), au tout début du document, qui donne les paramètres du document (type de format (pdf, html), l'auteur, la date, le thème, des paramètres pour le code R, un fichier de bibliographie...). Il est entouré des délimiteurs --- .

+ Des morceaux de code appelés **chunks**, dans lesquels les analyses et les calculs en R sont menés. 

Généralement, le premier chunk contient la fonction ```knitr::opts_chunk$set(echo = TRUE)```, qui peut être utilisée pour préciser des paramètres qui seront utilisés pour tous les chunks du document.

Toutes les options de chunks sont décrites dans la [documentation de Rmarkdown](https://rstudio.com/wp-content/uploads/2015/03/rmarkdown-reference.pdf?_ga=2.116494478.901299713.1598125979-1765392125.1580035352).

+ Des parties rédigées avec la syntaxe **markdown**. Il s'agit de texte brut enrichi de titres, sous titres, listes, insertion d'images, de liens, etc. Une description de cette syntaxe est également disponible dans la [documentation](https://rstudio.com/wp-content/uploads/2015/03/rmarkdown-reference.pdf?_ga=2.116494478.901299713.1598125979-1765392125.1580035352). De plus, la [syntaxe Latex](https://en.wikibooks.org/wiki/LaTeX/Mathematics) peut être utilisée pour faire le rendu d'équations mathématiques.

Vous avez par exemple ici un aperçu de ces trois composants, c'est à dire un header au format YAML, un chunk de code, et une partie textuelle en markdown : 

![Rmarkdown workflow.](./Images/chunk_example.png)

La syntaxe complète de Rmarkdown, dont vous allez avoir besoin par la suite, est dans cette [antisèche](https://raw.githubusercontent.com/rstudio/cheatsheets/master/rmarkdown-2.0.pdf), vous pouvez garder ce document ouvert au cours du TP.



# Mise en place

## Création du document

Ouvrez `Rstudio`. Nous allons créer un nouveau document ``Rmarkdown``. Dans la séance d'aujourd'hui, nous allons nous consacrer sur la création de rapports de type HTML (permettant de l'intéractivité contrairement aux PDFs). Pour ceci, dans le menu haut de Rstudio, choisissez Fichier/Nouveau fichier/R markdown, acceptez et laissez les valeurs par défaut.

Comme vous le constatez, RStudio propose déjà un petit exemple fonctionnel de document Rmarkdown. Sauvegardez le dans le répertoire `session5_rmarkdown/materiel`. Remarquez l'extension du fichier, `.Rmd`, qui diffère des `.R` des séances précédantes.

Pour créer le document html à partir du notebook, on utilise le bouton **Knit** (ou le raccourci clavier `Ctrl+Maj+K`). Le logiciel knitr est alors utilisé pour créer un document contenant le code et ses sorties, avec le reste du texte, puis le logiciel pandoc se charge de donner au document son format et apparence finale (html, pdf...). 

![Rmarkdown workflow.](./Images/rmarkdownflow.png)

## Prise en main

> **Challenge** Compilez votre document avec bouton Knit. Inspectez le résultat obtenu, ainsi que le code l'ayant généré. Repérez dans votre script quelles sont les parties qui correspondent au header, aux chunks, et à du markdown.

Personnalisez l'entête (header) YAML pour y ajouter votre nom, la date, et le titre du document. Compilez avec **Knit** (ou le raccourci clavier `Ctrl+Maj+K`), pour vérifier que vos modifications ont bien modifié le nom d'auteur, le titre, et la date dans le document html.

> **Challenge** A votre avis, comment faut-il modifier le document pour avoir un document compilé en PDF et non HTML?


Le premier chunk doit être conservé. Il permet de configurer des options gloable pour les chunks du documents, nous y reviendrons plus tard dans la séance. Dans ce premier chunk, rajoutez l'import des packages que nous allons utiliser: "tidyverse", "plotly". Exécutez le chunk, au moyen de la petite flèche verte en haut à droite du chunk, ou avec `Ctrl+Shift+Enter`.


Obervez la première ligne du chunk de code. Un chunk prend en option le langage utilisé (`r`), un nom éventuel (ici `setup`), ainsi qu'un certain nombre de paramètres. Par example, ```include = FALSE``` ne fait pas apparaître le code ni les résultats dans le document fini. ```echo = FALSE``` montre les sorties du code mais pas le code lui même. ```fig.cap = "Ma figure"``` attribue la légende désirée à une figure générée par le chunk. 
Cela explique pourquoi on ne voit pas le contenu du premier chunk de code dans le document compilé.


Vous pouvez ensuite supprimer la suite du document (l'exemple fourni par défaut), car nous allons remplir le document de nos propres analyses.


# Créer une section de contexte en `markdown`

A la suite du premier chunk, créez une première section nommée "Contexte" comme suit :`# Contexte`.

L'opérateur `#` permet d'indiquer un titre. Pour un sous titre, `##` peut être utilisé.

Décrivez plus bas la publication et les données que nous allons utiliser. Vous pouvez rappeler les auteurs, le titre de la publication, citez des phrases de l'abstract ou de la publication si celà vous paraît pertinent.

Compilez pour vous assurer que votre section apparaît dans le document.

## Mettre à profit la syntaxe markdown (liens, apparence du texte)

Nous voulons ajouter un lien pointant vers la publication que nous utilisons. Pour celà, la syntaxe markdown est la suivante ```[Label de votre lien clickable](url de la référence en ligne)```. 

Pour obtenir le résultat suivant :
Les données analysées sont issues d'une [publication intitulée "Fluctuating, warm temperatures decrease the effect of a key floral repressor on flowering time in Arabidopsis thaliana"](https://nph.onlinelibrary.wiley.com/doi/10.1111/nph.13799).

 

Il vous faut écrire dans la syntaxe markdown les lignes suivantes :

```{}
Les données analysées sont issues d'une [publication intitulée "Fluctuating, warm temperatures decrease the effect of a key floral repressor on flowering time in Arabidopsis thaliana"](https://nph.onlinelibrary.wiley.com/doi/10.1111/nph.13799)
```


Ajoutez ce lien à votre section de contexte et recompilez.



Les noms d'espèce végétales comme *Arabidopsis thaliana* doivent être écrits en italique. L'opérateur `*` placé de chaque côté des mots désirés permet d'utiliser de l'italique. Ajoutez le nom de l'organisme étudié à votre contexte (si ce n'est pas déjà fait), et placez le en italique.

> **Challenge** Comment mettre des mots en gras? (Indice: parcourez la [documentation de  Rmakdown](https://www.rstudio.com/wp-content/uploads/2015/03/rmarkdown-reference.pdf?_ga=2.116494478.901299713.1598125979-1765392125.1580035352))

# Import et affichage des données

Créez maintenant une nouvelle section intitulée "Analyse de la floraison", et une sous-section "Import et affichage des données".
Créez un nouveau chunk ( `avec Ctrl + Alt + I`, ou sous OS X: `Cmd + Option + I`). A l'intérieur, importez le jeu de données comme appris dans les séances précédantes, avec une fonction adaptée au type du fichier.

Exécutez le chunk. Vous devriez voir apparaître en dessous un aperçu de la sortie de la fonction d'import des données si elle retourne des messages. Si vous ne souhaitez pas voir apparaître ces messages dans le document compilé, donnez un argument au chunk afin de supprimer les messages générés par le code R : `message=FALSE`. Recompilez pour vérifier le résultat.

> **Challenge** Supprimez également les messages du chunk de setup relatifs à l'import des libraries

Dans le chunk d'import des données, vous pouvez appliquer les fonctions que vous souhaitez pour inspecter les données vues en cours précédants.

L'interactivité des rapports html permet d'inclure au rapport des tables de données interactives, grâce au package `DT` et sa fonction `datatable`. Affichez les données simplement, puis avec `datatable` comme suit et comparez le résultat dans le document compilé:

```{r, eval=FALSE}
expt1
datatable(expt1, filter="top", options = list(pageLength = 10, scrollX=T))
```


l' option pageLength permet d'afficher 10 lignes des données par page de tableau, et `scrollX=T` permet à la table interactive de ne pas dépasser de la largeur du document.

> **Challenge** Parcourez les données, et testez le filtre pour les variables quantitatives, permise par `filter="top"`.

Vous pouvez retirer de votre document l'affichage simple des données sans la fonction `datatable`, qui rendent bien moins bien et ne sont pas interactives.

# Extras


- [Des conseils de mise en forme pratiques et esthétiques](https://holtzy.github.io/Pimp-my-rmd/)


# Ressources et liens utiles

- [Antisèche pour Rmarkdown](https://raw.githubusercontent.com/rstudio/cheatsheets/master/rmarkdown-2.0.pdf)

- [Syntaxe Rmakdown](https://www.rstudio.com/wp-content/uploads/2015/03/rmarkdown-reference.pdf?_ga=2.116494478.901299713.1598125979-1765392125.1580035352)

-------

[Retour à la page d'accueil](https://scortijo.github.io/2021_L3_R/)

```{r}
# lien vers publi
# image html
# DT
# plotly


# référence bib
```

