---
title: "Correction de l'exam blanc"
output:
  html_document:
    toc: yes
    toc_float: yes 
  pdf_document:
    toc: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

[Retour à la page d'accueil](https://scortijo.github.io/2021_L3_R/)

<br>

## Préparation de l'environnement de travail

On charge le tidyverse et DT pour manipuler les dataframes, faire des graphiques, et représenter interactivement des tables.

```{r}
library(tidyverse)
library(DT)
```

Ici, on utilise la fonction `read_tsv` qui est adaptée aux fichiers texte avec une tabulation comme séparateur.

```{r}

#expt1 <- read_tsv("2021_L3_R/session6_exam_blanc/data/data_expression_cortijo2017.txt")
# ou, pour des questions de chemin, si l'exam est dans le repertoire de la session6/materiel:

expt1 <- read_tsv("../data/data_expression_cortijo2017.txt")

```

## Vérification des données

#### Question 1


On utilise dim qui permet de voir le nombre de lignes et de colonnes d'u dataframe :

```{r}

dim(expt1)

```

On a bien 1035 lignes, donc 1035 gènes.

Pour vérifier les données contenues, on utilise une fonction qui va nous montrer le nom des colonnes :

```{r}

head(expt1)
#ou 
names(expt1)

```

On a 8 colonnes : 

+ L'expression dans 6 conditions (en logFC)
+ Une colonne avec le nom du gène
+ Une colonne avec le cluster

#### Question 2

la fonction `glimpse` donne pour chaque colonne le type de donnée contenue (ou `visdat` qui donne cette info au format visuel):


```{r}

glimpse(expt1)
# et/ou 

vis_dat(expt1)
```
Les colonnes avec des valeurs d'expression sont des `dbl`, c'est à dire des nombres à virgule, tandis que les colonnes gene et cluster contiennent des `chr`, c'est à dire des chaines de charatères comme attendu. 


#### Question 3

On voudrait savoir quels sont les différents clusters possibles. Pour cela, on va récupérer cette colonne et montrer les valeurs uniques qu'elle contient :

```{r}

unique(expt1$cluster)

```




#### Question 4


Pour filtrer tout d'abord les données pour garder les deux gènes d'intérêt, on utilise `filter`, en demandant à ce que les valeurs de la colonne `gene` soient dans le vecteur `c("AT1G04520","AT3G12580")`.

Pour changer le format du tableau pour passer un format long avec une colonne contenant la condition experimentale et une colonne contenant les valeurs d'expression, on utilise `gather` sur les colonnes contenant l'expression dans les différentes conditions `Log2FoldToZero_17c_15min:Log2FoldToZero_27c_4hr`. On appelle la nouvelle clé est nommée `condition` et la colonne valeur est nommée `expression`.


Pour séparer la colonne des conditions expérimentales afin que la température et le temps du traitement soient dans deux colonnes différentes, c'est la fonction `separate` qu'il nous faut. Elle va découper les conditions de part et d'autre des underscores. On nomme les 3 nouvelles colonnes crées `"normalisation", "temperature", "temps"`.


On peut maintenant appeler `ggplot` pour tracer le graphique, qui aura en axis x le temps, en axe y l'expression.
On ajoute dans la fonction `aes` que la couleur doit être liée à la température. Comme on souhaite représenter une ligne par température différente, il faut préciser un `aes` supplémentaire, `group`, qui sera également associé à la température. 

On ajoute ensuite au ggplot la fonction `geom_line` pour tracer les lignes d'expression. 

Enfin, pour faire sous graphe par gène, on ajoute un `facet_wrap` sur la colonne gène.



```{r}

filter(expt1, gene%in%c("AT1G04520","AT3G12580")) %>% 
  gather(key="condition", value="expression", Log2FoldToZero_17c_15min:Log2FoldToZero_27c_4hr) %>% 
  separate(condition, into=c("normalisation", "temperature", "temps")) %>% 
  ggplot(aes(x=temps, y=expression,color=temperature, group=temperature)) +
  geom_line() +
  facet_wrap(~gene)

```

Pour AT1G04520, on observe bien que l'expression diminue au cours du temps à 17°C et 27°C et que cette diminution est plus rapide est plus importante à 27°C (ligne bleue).

Pour AT3G12580, on observe bien que l'expression augmente à 27°C de manière rapide et atteint son pic d'expression en 15 minutes avant de redescendre (courbe bleue). A 17°C, cette augmentation est présente mais moins forte (courbe rouge).

#### Question 5



```{r}

group_by(expt1, cluster) %>% 
  summarise(n.obs=n())


```




#### Question 6



```{r}


gather(expt1, key="condition", value="expression", Log2FoldToZero_17c_15min:Log2FoldToZero_27c_4hr) %>% 
  separate(condition, into=c("normalisation", "temperature", "temps")) %>% 
  ggplot(aes(x=temps, y=expression, fill=temperature )) +
  geom_violin() +
  facet_grid(~cluster)

gather(expt1, key="condition", value="expression", Log2FoldToZero_17c_15min:Log2FoldToZero_27c_4hr) %>% 
  separate(condition, into=c("normalisation", "temperature", "temps")) %>% 
  ggplot(aes(x=temps, y=expression, fill=temperature )) +
  geom_boxplot() +
  facet_grid(~cluster)


```












#### Question 8





```{r}


gene_fonction <- read_tsv("2021_L3_R/session6_exam_blanc/data/gene_fonction_cortijo2017.txt")

```




```{r}

gene_expression_fonction <- inner_join(gene_fonction, expt1, by="gene")

```




```{r}

filter(gene_expression_fonction, gene=="AT3G12580")
  

```




```{r}

filter(gene_expression_fonction, cluster=="cluster6A") %>% 
  datatable(filter="top", options = list(pageLength = 100, scrollX=T))

```





```{r}


datatable(gene_expression_fonction,filter="top", options = list(pageLength = 100, scrollX=T))

```










